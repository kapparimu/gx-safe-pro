<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GX-3R Pro å®‰å…¨ç®¡ç†ãƒ»AIã‚¢ã‚·ã‚¹ãƒˆãƒ­ã‚°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --safety-blue: #0ea5e9;
            --danger-red: #ef4444;
            --warning-orange: #f59e0b;
            --success-green: #10b981;
        }
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background-color: #f1f5f9;
            overscroll-behavior-y: contain;
            -webkit-tap-highlight-color: transparent;
        }
        .hidden-section { display: none !important; }
        .touch-target { min-height: 48px; }
        
        .val-danger { color: var(--danger-red); font-weight: 800; background-color: #fee2e2; }

        @media print {
            .no-print { display: none !important; }
            body { background-color: white !important; padding: 0 !important; }
            .print-only { display: block !important; }
            .print-container { width: 100% !important; margin: 0 !important; padding: 5px !important; }
            table { font-size: 7px !important; border-collapse: collapse !important; width: 100% !important; table-layout: fixed; }
            th, td { border: 1px solid #000 !important; padding: 2px !important; word-break: break-all; }
        }

        .dot-flashing {
            position: relative; width: 10px; height: 10px; border-radius: 5px;
            background-color: var(--safety-blue); animation: dot-flashing 1s infinite linear alternate;
        }
        @keyframes dot-flashing { 0% { opacity: 1; } 50%, 100% { opacity: 0.2; } }
        
        #custom-alert {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 9999; display: none;
        }

        #auth-error-overlay {
            position: fixed; inset: 0; background: rgba(15, 23, 42, 0.98); z-index: 10000;
            display: none; flex-direction: column; justify-content: center; align-items: center; color: white; padding: 20px; text-align: center;
        }
    </style>
</head>
<body class="pb-24">

    <!-- èªè¨¼ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã®æ¡ˆå†… -->
    <div id="auth-error-overlay">
        <div class="text-6xl mb-6">ğŸ”‘</div>
        <h2 class="text-2xl font-bold mb-4 text-white font-black">Firebaseã®è¨­å®šã‚’æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„</h2>
        <p class="text-slate-300 mb-8 max-w-md leading-relaxed text-sm">
            ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ï¼ˆã‚¯ãƒ©ã‚¦ãƒ‰é€£æºï¼‰ã‚’æœ‰åŠ¹ã«ã™ã‚‹ãŸã‚ã€Firebaseå´ã§ã€ŒåŒ¿åã‚µã‚¤ãƒ³ã‚¤ãƒ³ã€ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚<br><br>
            <strong>ã€è§£æ±ºã®æ‰‹é †ã€‘</strong><br>
            1. <a href="https://console.firebase.google.com/" target="_blank" class="text-sky-400 underline font-bold">Firebase Console</a> ã‚’é–‹ã<br>
            2. å·¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã® <strong>æ§‹ç¯‰ (Build)</strong> ï¼ <strong>Authentication</strong> ã‚’é–‹ã<br>
            3. <strong>Sign-in method</strong> ã‚¿ãƒ–ã‚’é¸æŠ<br>
            4. <strong>åŒ¿å (Anonymous)</strong> ã‚’æ¢ã—ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’<strong>ã€Œæœ‰åŠ¹ã€</strong>ã«ã—ã¦ä¿å­˜
        </p>
        <button onclick="location.reload()" class="bg-sky-500 hover:bg-sky-600 text-white font-black py-4 px-10 rounded-full transition-all shadow-xl active:scale-95">
            è¨­å®šãŒå®Œäº†ã—ã¾ã—ãŸ
        </button>
    </div>

    <div id="custom-alert" class="bg-slate-900 text-white px-6 py-4 rounded-2xl shadow-2xl flex items-center gap-3 border border-slate-700 max-w-[90%] w-full">
        <span id="alert-icon">â„¹ï¸</span>
        <p id="alert-message" class="text-xs font-bold leading-tight"></p>
    </div>

    <div id="global-loader" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[100] flex items-center justify-center hidden">
        <div class="dot-flashing"></div>
    </div>

    <header class="bg-slate-900 text-white p-4 sticky top-0 z-50 flex justify-between items-center shadow-lg no-print">
        <div>
            <h1 class="font-extrabold text-lg leading-tight tracking-tight">GX-SAFE <span class="text-sky-400 font-black">PRO</span></h1>
            <p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest text-white">Digital Safety Logbook</p>
        </div>
        <div id="sync-status" class="flex items-center gap-2 px-3 py-1.5 bg-slate-800 rounded-full border border-slate-700 shadow-inner">
            <div id="status-dot" class="w-2 h-2 rounded-full bg-slate-500 font-bold"></div>
            <span id="status-text" class="text-[10px] font-black tracking-tighter uppercase text-white font-black tracking-widest">OFFLINE</span>
        </div>
    </header>

    <main class="max-w-4xl mx-auto p-4 print-container">
        
        <!-- DASHBOARD TAB -->
        <section id="view-dashboard" class="space-y-4 no-print">
            <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-200">
                <label class="text-[10px] font-bold text-slate-400 uppercase mb-2 block tracking-wider font-black">ç®¡ç†æ—¥ä»˜ã®é¸æŠ</label>
                <input type="date" id="input-date" class="w-full bg-slate-50 border border-slate-200 rounded-2xl px-4 py-4 text-xl font-bold outline-none focus:ring-4 focus:ring-sky-500/20 transition-all touch-target font-black" onchange="loadTodayData()">
            </div>

            <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200">
                <h2 class="text-xs font-bold text-slate-400 uppercase mb-4 tracking-widest font-black">æœ¬æ—¥ã®ä½œæ¥­å†…å®¹</h2>
                <textarea id="work-content-area" rows="4" placeholder="ç¾å ´åã€æ‹…å½“è€…ãªã©ã‚’è¨˜å…¥..." 
                          class="w-full bg-slate-50 p-4 rounded-2xl border border-slate-200 text-base focus:ring-2 focus:ring-sky-500 outline-none transition-all font-bold"></textarea>
                <button onclick="saveWorkContent()" class="w-full mt-4 bg-slate-900 text-white text-sm font-bold py-4 rounded-2xl hover:bg-slate-800 active:scale-95 transition-all shadow-lg font-black uppercase tracking-widest">
                    ä½œæ¥­å†…å®¹ã‚’ä¿å­˜
                </button>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="bg-white p-5 rounded-3xl shadow-sm border-l-8 border-sky-500">
                    <p class="text-[10px] font-bold text-slate-400 uppercase font-black">æœ€æ–°é…¸ç´  O2</p>
                    <div class="flex items-baseline gap-1 mt-1 font-black">
                        <p id="dash-o2" class="text-4xl text-slate-800 font-black">--.-</p>
                        <span class="text-sm text-slate-400">%</span>
                    </div>
                </div>
                <div class="bg-white p-5 rounded-3xl shadow-sm border-l-8 border-rose-500">
                    <p class="text-[10px] font-bold text-slate-400 uppercase font-black">æœ€æ–°ãƒ¡ã‚¿ãƒ³ LEL</p>
                    <div class="flex items-baseline gap-1 mt-1 font-black">
                        <p id="dash-lel" class="text-4xl text-slate-800 font-black">--</p>
                        <span class="text-sm text-slate-400">%</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- INPUT TAB -->
        <section id="view-daily" class="hidden-section no-print space-y-6">
            <div class="bg-amber-50 border border-amber-200 p-4 rounded-2xl shadow-sm">
                <h3 class="text-amber-800 text-xs font-bold mb-2 flex items-center gap-2 font-black tracking-tight uppercase">âš ï¸ å®‰å…¨åˆ¤æ–­ã®ç›®å®‰ï¼ˆé€€é¿åŸºæº–ï¼‰</h3>
                <div class="grid grid-cols-2 gap-y-1 text-[10px] text-amber-700 font-bold">
                    <div>é…¸ç´ (O2): <span class="text-rose-600 font-black tracking-widest">18.0% ä»¥ä¸‹</span></div>
                    <div>å¯ç‡ƒæ€§(LEL): <span class="text-rose-600 font-black tracking-widest">25% ä»¥ä¸Š</span></div>
                    <div>ä¸€é…¸åŒ–(CO): <span class="text-rose-600 font-black tracking-widest">50ppm ä»¥ä¸Š</span></div>
                    <div>ç¡«åŒ–æ°´ç´ (H2S): <span class="text-rose-600 font-black tracking-widest">5.0ppm ä»¥ä¸Š</span></div>
                </div>
            </div>

            <h2 class="text-2xl font-black text-slate-800 flex items-center gap-2 font-black">
                è¨˜éŒ²å…¥åŠ› <span id="current-date-badge" class="text-xs bg-slate-200 px-3 py-1 rounded-full text-slate-500 font-bold tracking-tight">----/--/--</span>
            </h2>

            <div id="entry-accordion" class="space-y-4 font-bold">
                <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden shadow-sm">
                    <button onclick="toggleAccordion('inspection')" class="w-full p-5 flex justify-between items-center bg-slate-800 text-white active:bg-slate-700 transition-colors">
                        <div class="text-left">
                            <span class="text-[10px] font-black text-sky-400 uppercase tracking-widest font-black">Step 1</span>
                            <h3 class="font-bold text-lg text-white font-black">æ©Ÿå™¨ã®å§‹å‹•å‰ç‚¹æ¤œ</h3>
                        </div>
                        <span id="badge-inspection" class="text-[10px] px-3 py-1 bg-slate-700 text-slate-300 rounded-full font-black tracking-widest">æœªç¢ºèª</span>
                    </button>
                    <div id="content-inspection" class="p-5 space-y-3 hidden"><div id="inspection-items-container" class="grid grid-cols-1 gap-3"></div></div>
                </div>
                <div id="measurement-points-container" class="space-y-4"></div>
            </div>

            <button onclick="saveDailyRecord()" class="w-full bg-slate-900 text-white font-black py-6 rounded-3xl shadow-2xl active:scale-95 transition-all text-lg flex items-center justify-center gap-3 font-black uppercase tracking-widest">
                <span>ğŸ’¾</span> è¨˜éŒ²ã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜
            </button>
        </section>

        <!-- REPORT TAB -->
        <section id="view-monthly" class="hidden-section space-y-4">
            <div class="no-print flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
                <h2 class="text-2xl font-black text-slate-800 font-black tracking-tight uppercase">æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆ</h2>
                <div class="flex gap-2 w-full md:w-auto">
                    <select id="report-month" class="flex-1 bg-white border border-slate-200 rounded-2xl px-4 py-3 text-sm font-bold shadow-sm font-black" onchange="loadMonthlyTable()"></select>
                    <button onclick="loadMonthlyTable()" class="bg-white border border-slate-200 px-4 rounded-2xl text-lg shadow-sm active:scale-90 transition-transform font-black">ğŸ”„</button>
                    <button onclick="triggerPrint()" class="bg-sky-600 text-white px-6 py-3 rounded-2xl text-sm font-bold shadow-lg flex items-center justify-center gap-2 active:bg-sky-700 font-black uppercase tracking-widest"><span>ğŸ–¨ï¸</span> å°åˆ·</button>
                </div>
            </div>

            <div class="bg-white p-1 rounded-2xl border border-slate-200 overflow-x-auto shadow-sm print-container">
                <div class="print-only hidden text-center mb-4"><h1 class="text-lg font-bold font-black">ãƒãƒ¼ã‚¿ãƒ–ãƒ«ã‚¬ã‚¹ãƒ¢ãƒ‹ã‚¿ãƒ¼ GX-3R Pro è¨ˆæ¸¬è¨˜éŒ²ç¥¨</h1><p class="text-xs font-bold" id="print-month-title"></p></div>
                <table class="w-full text-left border-collapse" id="monthly-table"></table>
            </div>
        </section>
    </main>

    <nav class="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-md border-t border-slate-200 px-6 py-4 flex justify-between items-center z-[100] no-print shadow-lg">
        <button onclick="switchTab('dashboard')" id="nav-dashboard" class="flex flex-col items-center gap-1 text-sky-600 font-black transition-all"><span class="text-2xl">ğŸ </span><span class="text-[10px] uppercase font-black tracking-tighter">Home</span></button>
        <button onclick="switchTab('daily')" id="nav-daily" class="flex flex-col items-center gap-1 text-slate-400 font-black transition-all"><span class="text-2xl">âœï¸</span><span class="text-[10px] uppercase font-black tracking-tighter">Input</span></button>
        <button onclick="switchTab('monthly')" id="nav-monthly" class="flex flex-col items-center gap-1 text-slate-400 font-black transition-all"><span class="text-2xl">ğŸ“…</span><span class="text-[10px] uppercase font-black tracking-tighter">Report</span></button>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const config = {
            measurementPoints: [
                { id: 'p1', label: 'é–‹å§‹å‰', type: 'ãƒãƒ³ãƒ—' },
                { id: 'p2', label: 'AMä½œæ¥­', type: 'æºå¸¯' },
                { id: 'p3', label: 'PMé–‹å§‹', type: 'ãƒãƒ³ãƒ—' },
                { id: 'p4', label: 'PMä½œæ¥­', type: 'æºå¸¯' },
                { id: 'p5', label: 'çµ‚äº†æ™‚', type: 'æºå¸¯' }
            ],
            gases: [
                { id: 'o2', label: 'é…¸ç´ ', unit: '%', step: '0.1', default: '20.9', threshold: 18.0, type: 'min' },
                { id: 'lel', label: 'ãƒ¡ã‚¿ãƒ³', unit: '%', step: '1', default: '0', threshold: 25, type: 'max' },
                { id: 'co', label: 'ä¸€é…¸åŒ–', unit: 'ppm', step: '1', default: '0', threshold: 50, type: 'max' },
                { id: 'h2s', label: 'ç¡«åŒ–æ°´ç´ ', unit: 'ppm', step: '0.1', default: '0.0', threshold: 5.0, type: 'max' }
            ],
            inspectionItems: [{ id: 'batt', label: 'é›»æ± æ®‹é‡' }, { id: 'case', label: 'ç­ä½“ç ´æ' }, { id: 'filter', label: 'ãƒ•ã‚£ãƒ«ã‚¿' }, { id: 'heart', label: 'å‹•ä½œè¡¨ç¤º' }]
        };

        const firebaseConfig = {
            apiKey: "AIzaSyB7CsmHTM1opph0rU_mh13YO7MCsF4hY48",
            authDomain: "gx-safe-pro-data.firebaseapp.com",
            projectId: "gx-safe-pro-data",
            storageBucket: "gx-safe-pro-data.firebasestorage.app",
            messagingSenderId: "264176312785",
            appId: "1:264176312785:web:44ed11c4f0dbbeb8f5c0f0",
            measurementId: "G-1MZCE0R6Y2"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'gx3r-log-system-v2';

        let currentUser = null;
        let todayData = {};
        let inspectionState = {};

        const getLocalDateString = (date) => {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        };

        const showLoader = (show) => { 
            const loader = document.getElementById('global-loader');
            if(loader) loader.classList.toggle('hidden', !show); 
        };

        window.showMessage = (msg, icon = "â„¹ï¸") => {
            const box = document.getElementById('custom-alert');
            const iconEl = document.getElementById('alert-icon');
            const msgEl = document.getElementById('alert-message');
            if(!box || !iconEl || !msgEl) return;
            iconEl.innerText = icon;
            msgEl.innerText = msg;
            box.style.display = "flex";
            setTimeout(() => { box.style.display = "none"; }, 6000);
        };

        window.triggerPrint = () => { window.print(); };

        window.switchTab = (tabId) => {
            ['dashboard', 'daily', 'monthly'].forEach(id => {
                const el = document.getElementById('view-' + id);
                if (el) el.classList.add('hidden-section');
                const nav = document.getElementById('nav-' + id);
                if (nav) nav.classList.replace('text-sky-600', 'text-slate-400');
            });
            const target = document.getElementById('view-' + tabId);
            if (target) {
                target.classList.remove('hidden-section');
                const nav = document.getElementById('nav-' + tabId);
                if (nav) nav.classList.replace('text-slate-400', 'text-sky-600');
                if (tabId === 'daily') window.loadTodayData();
                if (tabId === 'monthly') window.loadMonthlyTable();
            }
            window.scrollTo(0, 0);
        };

        const getRecordPath = (dateStr) => doc(db, 'artifacts', appId, 'public', 'data', 'daily_records', dateStr);

        window.loadTodayData = async () => {
            if (!currentUser || !db) return;
            const dateStr = document.getElementById('input-date').value;
            if (!dateStr) return;
            showLoader(true);
            try {
                const snap = await getDoc(getRecordPath(dateStr));
                todayData = snap.exists() ? snap.data() : {};
                document.getElementById('work-content-area').value = todayData.work_content || '';
                document.getElementById('current-date-badge').innerText = dateStr;
                inspectionState = todayData.inspection || {};
                renderInspectionUI(); renderEntryForms(); updateDashboardSummary();
            } catch (err) { console.error("Load failed", err); } finally { showLoader(false); }
        };

        window.saveDailyRecord = async () => {
            if (!currentUser) { window.showMessage("æ¥ç¶šå¾…ã¡...", "â³"); return; }
            const dateStr = document.getElementById('input-date').value;
            showLoader(true);
            const record = { inspection: inspectionState, work_content: document.getElementById('work-content-area').value, timestamp: Date.now() };
            config.measurementPoints.forEach(p => {
                const pData = {}; let has = false;
                config.gases.forEach(g => { 
                    const el = document.getElementById(p.id + '-' + g.id); 
                    if (el && el.value !== '') { pData[g.id] = g.step === '1' ? parseInt(el.value) : parseFloat(el.value); has = true; } 
                });
                if (has) record[p.id] = pData;
            });
            try {
                await setDoc(getRecordPath(dateStr), record, { merge: true });
                window.showMessage("ä¿å­˜ã—ã¾ã—ãŸ", "âœ…"); window.switchTab('dashboard');
            } catch (err) { window.showMessage("ä¿å­˜å¤±æ•—", "âŒ"); } finally { showLoader(false); }
        };

        window.saveWorkContent = async () => {
            if (!currentUser || !db) return;
            const dateStr = document.getElementById('input-date').value;
            try {
                await setDoc(getRecordPath(dateStr), { work_content: document.getElementById('work-content-area').value }, { merge: true });
                window.showMessage("ä¿å­˜ã—ã¾ã—ãŸ", "âœ…");
            } catch (e) { console.error(e); }
        };

        function renderInspectionUI() {
            const container = document.getElementById('inspection-items-container');
            if(!container) return;
            container.innerHTML = config.inspectionItems.map(item => `
                <div class="flex justify-between items-center bg-slate-50 p-4 rounded-2xl border border-slate-100 shadow-inner">
                    <p class="text-sm font-bold text-slate-700 font-black tracking-tight uppercase font-black">${item.label}</p>
                    <div class="flex bg-white rounded-xl p-1 border shadow-sm">
                        <button onclick="setInspection('${item.id}', true)" class="px-5 py-2 rounded-lg text-xs font-bold transition-all ${inspectionState[item.id] === true ? 'bg-emerald-500 text-white shadow-md' : 'text-slate-400 hover:bg-slate-100'} font-black">è‰¯</button>
                        <button onclick="setInspection('${item.id}', false)" class="px-5 py-2 rounded-lg text-xs font-bold transition-all ${inspectionState[item.id] === false ? 'bg-rose-500 text-white shadow-md' : 'text-slate-400 hover:bg-slate-100'} font-black">å¦</button>
                    </div>
                </div>`).join('');
            const isOk = config.inspectionItems.every(i => inspectionState[i.id] === true);
            const badge = document.getElementById('badge-inspection');
            if(badge) {
                badge.innerText = isOk ? 'ç¢ºèªæ¸ˆ' : 'æœªç¢ºèª';
                badge.className = `text-[10px] px-3 py-1 ${isOk ? 'bg-emerald-500 text-white' : 'bg-slate-700 text-slate-300'} rounded-full font-black tracking-widest font-black`;
            }
        }
        window.setInspection = (id, val) => { inspectionState[id] = val; renderInspectionUI(); };
        window.toggleAccordion = (id) => { const el = document.getElementById('content-' + id); if(el) el.classList.toggle('hidden'); };
        window.handleManualInput = (pointId) => {
            const has = config.gases.some(g => { const el = document.getElementById(pointId + '-' + g.id); return el && el.value !== ''; });
            const badge = document.getElementById('badge-' + pointId);
            if(badge) badge.className = `text-[10px] px-3 py-1 ${has ? 'bg-emerald-100 text-emerald-600' : 'bg-slate-200 text-slate-500'} rounded-full font-black`;
        };

        function renderEntryForms() {
            const container = document.getElementById('measurement-points-container');
            if(!container) return;
            container.innerHTML = config.measurementPoints.map(p => `
                <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden shadow-sm">
                    <button onclick="toggleAccordion('${p.id}')" class="w-full p-5 flex justify-between items-center bg-slate-50 hover:bg-slate-100 transition-colors">
                        <div class="text-left"><h3 class="font-bold text-slate-800 text-lg font-black uppercase tracking-tight font-black">${p.label}</h3></div>
                        <span id="badge-${p.id}" class="text-[10px] px-3 py-1 ${(todayData[p.id]) ? 'bg-emerald-100 text-emerald-600' : 'bg-slate-200 text-slate-500'} rounded-full font-black">${(todayData[p.id]) ? 'æ¸ˆ' : 'æœª'}</span>
                    </button>
                    <div id="content-${p.id}" class="p-6 grid grid-cols-2 gap-4 hidden border-t">
                        ${config.gases.map(g => `
                            <div class="space-y-1">
                                <label class="text-[11px] font-bold text-slate-400 uppercase tracking-tight font-black">${g.label}</label>
                                <input type="number" step="${g.step}" id="${p.id}-${g.id}" oninput="handleManualInput('${p.id}')" value="${todayData[p.id]?.[g.id] || ''}" class="w-full bg-slate-50 p-4 rounded-2xl border font-bold touch-target outline-none focus:ring-2 focus:ring-sky-500/50 transition-all font-black">
                                <p class="text-[8px] text-slate-400 leading-tight font-black uppercase tracking-tighter">é€€é¿: ${g.type==='min'?g.threshold+'%â†“':g.threshold+g.unit+'â†‘'}</p>
                            </div>`).join('')}
                    </div>
                </div>`).join('');
            config.measurementPoints.forEach(p => handleManualInput(p.id));
        }

        window.loadMonthlyTable = async () => {
            if (!currentUser || !db) return;
            const monthVal = document.getElementById('report-month').value;
            const table = document.getElementById('monthly-table');
            const printTitle = document.getElementById('print-month-title');
            if(printTitle) printTitle.innerText = monthVal + " åˆ†";
            table.innerHTML = `<thead class="bg-slate-900 text-white"><tr><th class="p-2 border text-center font-black" rowspan="2" style="width:60px text-xs uppercase tracking-widest font-black">æ—¥ä»˜</th><th class="p-2 border text-center font-black" rowspan="2" style="width:30px text-xs uppercase tracking-widest font-black">ç‚¹æ¤œ</th>${config.measurementPoints.map(p => `<th class="p-1 border text-center text-[8px] font-black" colspan="4 uppercase tracking-tighter font-black">${p.label.substring(0,2)}</th>`).join('')}</tr><tr class="bg-slate-800 text-[6px] font-black">${config.measurementPoints.map(p => `<th class="p-1 border text-center uppercase font-black">O2</th><th class="p-1 border text-center uppercase font-black">LEL</th><th class="p-1 border text-center uppercase font-black">CO</th><th class="p-1 border text-center uppercase font-black">H2S</th>`).join('')}</tr></thead><tbody id="mtb"></tbody>`;
            try {
                const snap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'daily_records'));
                const monthData = snap.docs.filter(d => d.id.startsWith(monthVal)).sort((a,b) => a.id.localeCompare(b.id));
                const body = document.getElementById('mtb');
                if(body) {
                    body.innerHTML = monthData.map(doc => {
                        const d = doc.data(); 
                        const dateLabel = `${parseInt(doc.id.split('-')[1])}æœˆ${parseInt(doc.id.split('-')[2])}æ—¥`;
                        const isOk = d.inspection && Object.values(d.inspection).every(v => v === true);
                        let row = `<tr><td class="border p-1 text-[9px] font-bold text-center bg-slate-50 font-black">${dateLabel}</td><td class="border p-1 text-center text-[8px] font-bold ${isOk ? 'text-emerald-600' : 'text-rose-500'} font-black">${isOk ? 'OK' : 'NG'}</td>`;
                        config.measurementPoints.forEach(p => { 
                            const pD = d[p.id] || {};
                            config.gases.forEach(g => {
                                const val = pD[g.id];
                                let isDanger = (val !== undefined) && ((g.type === 'min' && val <= g.threshold) || (g.type === 'max' && val >= g.threshold));
                                row += `<td class="border p-1 text-center text-[7px] font-bold ${isDanger ? 'val-danger' : ''}">${val ?? '-'}</td>`;
                            });
                        });
                        return row + `</tr>`;
                    }).join('');
                }
            } catch (err) { console.error("Load failed", err); }
        };

        window.updateDashboardSummary = () => {
            const points = [...config.measurementPoints].reverse();
            let lastData = null;
            for (const p of points) { if (todayData && todayData[p.id]) { lastData = todayData[p.id]; break; } }
            if (lastData) {
                document.getElementById('dash-o2').innerText = lastData.o2?.toFixed(1) || '--.-';
                document.getElementById('dash-lel').innerText = lastData.lel || '--';
            }
        };

        const initAuth = async () => {
            try {
                await signInAnonymously(auth);
            } catch (e) {
                if (e.code === 'auth/configuration-not-found' || e.code === 'auth/operation-not-allowed') {
                    document.getElementById('auth-error-overlay').style.display = 'flex';
                }
            }
        };

        onAuthStateChanged(auth, (user) => { 
            currentUser = user;
            const dot = document.getElementById('status-dot');
            const txt = document.getElementById('status-text');
            if (user) {
                if(dot) dot.className = "w-2 h-2 rounded-full bg-emerald-500 animate-pulse transition-all shadow-[0_0_8px_rgba(16,185,129,0.5)]";
                if(txt) { txt.innerText = "CONNECTED"; txt.classList.add("text-emerald-400"); }
                window.loadTodayData(); 
            } else { 
                if(dot) dot.className = "w-2 h-2 rounded-full bg-rose-500 transition-all"; 
                if(txt) { txt.innerText = "OFFLINE"; txt.classList.remove("text-emerald-400"); }
            }
        });

        window.onload = () => {
            initAuth();
            const select = document.getElementById('report-month');
            const now = new Date();
            for (let m = 1; m <= 7; m++) {
                const opt = document.createElement('option');
                opt.value = `2026-${String(m).padStart(2, '0')}`;
                opt.text = `2026å¹´${m}æœˆ`;
                select.appendChild(opt);
            }
            select.value = "2026-01";
            document.getElementById('input-date').value = getLocalDateString(new Date());
            renderInspectionUI(); renderEntryForms();
        };
    </script>
</body>
</html>
