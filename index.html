<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GX-3R Pro å®‰å…¨ç®¡ç†ãƒ»AIã‚¢ã‚·ã‚¹ãƒˆãƒ­ã‚°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --safety-blue: #0ea5e9;
            --danger-red: #ef4444;
            --success-green: #10b981;
        }
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background-color: #f1f5f9;
            overscroll-behavior-y: contain;
        }
        .hidden-section { display: none !important; }
        .touch-target { min-height: 48px; }
        
        /* å°åˆ·è¨­å®š */
        @media print {
            .no-print { display: none !important; }
            body { background-color: white !important; padding: 0 !important; }
            .print-only { display: block !important; }
            .print-container { width: 100% !important; margin: 0 !important; padding: 5px !important; }
            table { font-size: 7px !important; border-collapse: collapse !important; width: 100% !important; table-layout: fixed; }
            th, td { border: 1px solid #000 !important; padding: 2px !important; word-break: break-all; }
            .page-break { page-break-before: always; }
        }

        .input-focus:focus { outline: 3px solid var(--safety-blue); border-color: transparent; }
        .dot-flashing {
            position: relative; width: 10px; height: 10px; border-radius: 5px;
            background-color: var(--safety-blue); animation: dot-flashing 1s infinite linear alternate;
        }
        @keyframes dot-flashing { 0% { opacity: 1; } 50%, 100% { opacity: 0.2; } }
        
        .ai-glow {
            box-shadow: 0 0 20px rgba(14, 165, 233, 0.2);
            border: 1px solid rgba(14, 165, 233, 0.3);
        }

        /* ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ç”¨ */
        #custom-alert {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 2000; display: none;
        }
    </style>
</head>
<body class="pb-24">

    <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€šçŸ¥ç”¨ -->
    <div id="custom-alert" class="bg-slate-800 text-white px-6 py-4 rounded-2xl shadow-2xl flex items-center gap-3 border border-slate-700 max-w-[90%]">
        <span id="alert-icon">â„¹ï¸</span>
        <p id="alert-message" class="text-xs font-bold leading-tight"></p>
    </div>

    <!-- Global Loading Overlay -->
    <div id="global-loader" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[100] flex items-center justify-center hidden">
        <div class="dot-flashing"></div>
    </div>

    <!-- Header -->
    <header class="bg-slate-900 text-white p-4 sticky top-0 z-50 flex justify-between items-center shadow-lg no-print">
        <div>
            <h1 class="font-extrabold text-lg leading-tight">GX-SAFE <span class="text-sky-400">PRO</span></h1>
            <p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest">Digital Safety Logbook</p>
        </div>
        <div id="sync-status" class="flex items-center gap-2 px-3 py-1.5 bg-slate-800 rounded-full border border-slate-700">
            <div class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>
            <span class="text-[10px] font-bold">LIVE SYNC</span>
        </div>
    </header>

    <main class="max-w-4xl mx-auto p-4 print-container">
        
        <!-- DASHBOARD (Home) -->
        <section id="view-dashboard" class="space-y-4 no-print">
            <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-200">
                <label class="text-[10px] font-bold text-slate-400 uppercase mb-2 block tracking-wider">ç®¡ç†æ—¥ä»˜ã®é¸æŠ</label>
                <input type="date" id="input-date" class="w-full bg-slate-50 border border-slate-200 rounded-2xl px-4 py-4 text-xl font-bold outline-none focus:ring-4 focus:ring-sky-500/20 transition-all touch-target" onchange="loadTodayData()">
            </div>

            <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200">
                <h2 class="text-xs font-bold text-slate-400 uppercase mb-4 tracking-widest">æœ¬æ—¥ã®ä½œæ¥­å†…å®¹</h2>
                <textarea id="work-content-area" rows="4" placeholder="ç¾å ´åã€ä½œæ¥­ç›®çš„ã€è²¬ä»»è€…ãªã©ã‚’è¨˜å…¥..." 
                          class="w-full bg-slate-50 p-4 rounded-2xl border border-slate-200 text-base focus:ring-2 focus:ring-sky-500 outline-none transition-all"></textarea>
                <div class="flex gap-3 mt-4">
                    <button onclick="saveWorkContent()" class="flex-1 bg-slate-900 text-white text-sm font-bold py-4 rounded-2xl hover:bg-slate-800 active:scale-95 transition-all shadow-lg">
                        ä½œæ¥­æƒ…å ±ã‚’ä¿å­˜
                    </button>
                    <button onclick="generateRiskAssessment()" class="flex-1 bg-sky-600 text-white text-sm font-bold py-4 rounded-2xl shadow-md hover:bg-sky-700 active:scale-95 transition-all flex items-center justify-center gap-2">
                        <span>âœ¨</span> å®‰å…¨ãƒªã‚¹ã‚¯äºˆæ¸¬
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="bg-white p-5 rounded-3xl shadow-sm border-l-8 border-sky-500">
                    <p class="text-[10px] font-bold text-slate-400 uppercase">æœ€æ–°é…¸ç´  O2</p>
                    <div class="flex items-baseline gap-1 mt-1">
                        <p id="dash-o2" class="text-4xl font-black text-slate-800">--.-</p>
                        <span class="text-sm font-bold text-slate-400">%</span>
                    </div>
                </div>
                <div class="bg-white p-5 rounded-3xl shadow-sm border-l-8 border-rose-500">
                    <p class="text-[10px] font-bold text-slate-400 uppercase">æœ€æ–°ãƒ¡ã‚¿ãƒ³ LEL</p>
                    <div class="flex items-baseline gap-1 mt-1">
                        <p id="dash-lel" class="text-4xl font-black text-slate-800">--</p>
                        <span class="text-sm font-bold text-slate-400">%</span>
                    </div>
                </div>
            </div>

            <div id="ai-insight-card" class="bg-white p-6 rounded-3xl border border-sky-100 ai-glow relative overflow-hidden">
                <div class="absolute top-0 right-0 p-4 opacity-5"><span class="text-6xl text-sky-500">âœ¨</span></div>
                <h3 class="font-bold text-slate-800 flex items-center gap-2 mb-3">
                    <span class="text-sky-500">âœ¨</span> AIå®‰å…¨ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼
                </h3>
                <div id="dash-ai-text" class="text-sm text-slate-600 leading-relaxed min-h-[50px]">
                    ç¾å ´ã®çŠ¶æ³ã‚’åˆ†æã™ã‚‹ãŸã‚ã«ã€ã¾ãšã¯ä½œæ¥­å†…å®¹ã¾ãŸã¯è¨ˆæ¸¬å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
                </div>
                <div id="ai-action-buttons" class="hidden mt-4 pt-4 border-t border-slate-100 flex gap-3">
                    <button id="btn-speak-dash" class="flex-1 text-xs font-bold py-3 bg-sky-50 text-sky-700 rounded-xl border border-sky-100 flex items-center justify-center gap-2">
                        ğŸ“¢ æŒ‡ç¤ºã‚’éŸ³å£°ã§è´ã
                    </button>
                </div>
            </div>
        </section>

        <!-- DAILY LOG (ENTRY) -->
        <section id="view-daily" class="hidden-section no-print space-y-6">
            <h2 class="text-2xl font-black text-slate-800 flex items-center gap-2">
                è¨˜éŒ²å…¥åŠ› <span id="current-date-badge" class="text-xs bg-slate-200 px-3 py-1 rounded-full text-slate-500">----/--/--</span>
            </h2>

            <div id="entry-accordion" class="space-y-4">
                <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden shadow-sm">
                    <button onclick="toggleAccordion('inspection')" class="w-full p-5 flex justify-between items-center bg-slate-800 text-white">
                        <div class="text-left">
                            <span class="text-[10px] font-black text-sky-400 uppercase tracking-widest">Step 1</span>
                            <h3 class="font-bold text-lg">æ©Ÿå™¨ã®å§‹å‹•å‰ç‚¹æ¤œ</h3>
                        </div>
                        <span id="badge-inspection" class="text-[10px] px-3 py-1 bg-slate-700 text-slate-300 rounded-full font-bold">æœªç¢ºèª</span>
                    </button>
                    <div id="content-inspection" class="p-5 space-y-3 hidden">
                        <div id="inspection-items-container" class="grid grid-cols-1 gap-3"></div>
                    </div>
                </div>
                <div id="measurement-points-container" class="space-y-4"></div>
            </div>

            <button onclick="saveDailyRecord()" class="w-full bg-slate-900 text-white font-black py-6 rounded-3xl shadow-2xl active:scale-95 transition-all text-lg">
                è¨˜éŒ²ã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜
            </button>
        </section>

        <!-- MONTHLY REPORT -->
        <section id="view-monthly" class="hidden-section space-y-4">
            <div class="no-print flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
                <h2 class="text-2xl font-black text-slate-800">æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆ</h2>
                <div class="flex gap-2 w-full md:w-auto">
                    <select id="report-month" class="flex-1 bg-white border border-slate-200 rounded-2xl px-4 py-3 text-sm font-bold shadow-sm" onchange="loadMonthlyTable()"></select>
                    <button onclick="loadMonthlyTable()" class="bg-white border border-slate-200 px-4 rounded-2xl text-lg shadow-sm">ğŸ”„</button>
                    <button onclick="triggerPrint()" class="bg-sky-600 text-white px-6 py-3 rounded-2xl text-sm font-bold shadow-lg flex items-center gap-2">
                        <span>ğŸ–¨ï¸</span> å°åˆ·
                    </button>
                </div>
            </div>

            <div class="bg-white p-2 rounded-2xl border border-slate-200 overflow-x-auto shadow-sm print-container">
                <div class="print-only hidden text-center mb-6">
                    <h1 class="text-lg font-bold">ãƒãƒ¼ã‚¿ãƒ–ãƒ«ã‚¬ã‚¹ãƒ¢ãƒ‹ã‚¿ãƒ¼ GX-3R Pro è¨ˆæ¸¬è¨˜éŒ²ç¥¨</h1>
                    <p class="text-xs" id="print-month-title"></p>
                </div>
                <table class="w-full text-left border-collapse" id="monthly-table"></table>
            </div>
        </section>

        <!-- AI Tab -->
        <section id="view-ai" class="hidden-section no-print space-y-4">
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 bg-sky-100 rounded-full mx-auto flex items-center justify-center text-2xl mb-2">âœ¨</div>
                    <h2 class="text-lg font-bold">Safety AI Assistant</h2>
                </div>
                <div id="ai-chat-area" class="bg-slate-50 p-4 rounded-2xl min-h-[250px] text-sm text-slate-700 leading-relaxed mb-4 border border-slate-200">
                    æœ¬æ—¥ã®ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã€æ½œåœ¨çš„ãªå±é™ºæ€§ã‚’äºˆæ¸¬ã—ã¾ã™ã€‚
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="analyzeSafety()" class="bg-sky-600 text-white font-bold py-4 rounded-2xl shadow-lg flex items-center justify-center gap-2">âœ¨ ãƒ‡ãƒ¼ã‚¿åˆ†æ</button>
                    <button id="btn-ai-speak" disabled class="bg-slate-100 text-slate-400 font-bold py-4 rounded-2xl border border-slate-200 flex items-center justify-center gap-2">ğŸ“¢ éŸ³å£°è§£èª¬</button>
                </div>
            </div>
        </section>

    </main>

    <!-- Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-md border-t border-slate-200 px-6 py-4 flex justify-between items-center z-50 no-print shadow-[0_-10px_30px_rgba(0,0,0,0.05)]">
        <button onclick="switchTab('dashboard')" id="nav-dashboard" class="flex flex-col items-center gap-1 text-sky-600">
            <span class="text-2xl">ğŸ </span><span class="text-[10px] font-extrabold uppercase">Home</span>
        </button>
        <button onclick="switchTab('daily')" id="nav-daily" class="flex flex-col items-center gap-1 text-slate-400">
            <span class="text-2xl">âœï¸</span><span class="text-[10px] font-extrabold uppercase">Input</span>
        </button>
        <button onclick="switchTab('monthly')" id="nav-monthly" class="flex flex-col items-center gap-1 text-slate-400">
            <span class="text-2xl">ğŸ“…</span><span class="text-[10px] font-extrabold uppercase">Report</span>
        </button>
        <button onclick="switchTab('ai')" id="nav-ai" class="flex flex-col items-center gap-1 text-slate-400">
            <span class="text-2xl">âœ¨</span><span class="text-[10px] font-extrabold uppercase">AI</span>
        </button>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 1. CONFIGURATION ---
        const config = {
            measurementPoints: [
                { id: 'p1', label: 'ä½œæ¥­é–‹å§‹å‰', type: 'ãƒãƒ³ãƒ—' },
                { id: 'p2', label: 'åˆå‰ä½œæ¥­ä¸­', type: 'æºå¸¯' },
                { id: 'p3', label: 'åˆå¾Œé–‹å§‹å‰', type: 'ãƒãƒ³ãƒ—' },
                { id: 'p4', label: 'åˆå¾Œä½œæ¥­ä¸­', type: 'æºå¸¯' },
                { id: 'p5', label: 'ä½œæ¥­çµ‚äº†æ™‚', type: 'æºå¸¯' }
            ],
            gases: [
                { id: 'o2', label: 'é…¸ç´ ', unit: '%', step: '0.1', default: '20.9', threshold: { min: 19.5, max: 23.5 } },
                { id: 'lel', label: 'ãƒ¡ã‚¿ãƒ³', unit: '%', step: '1', default: '0', threshold: { max: 10 } },
                { id: 'co', label: 'ä¸€é…¸åŒ–ç‚­ç´ ', unit: 'ppm', step: '1', default: '0', threshold: { max: 50 } },
                { id: 'h2s', label: 'ç¡«åŒ–æ°´ç´ ', unit: 'ppm', step: '0.1', default: '0.0', threshold: { max: 1.0 } }
            ],
            inspectionItems: [
                { id: 'batt', label: 'é›»æ± æ®‹é‡', desc: '3ãƒ–ãƒ­ãƒƒã‚¯ç‚¹ç¯ã‚’ç¢ºèª' },
                { id: 'case', label: 'ç­ä½“ç ´æ', desc: 'ã²ã³å‰²ã‚Œã€ãƒã‚¸ç·©ã¿ãªã—' },
                { id: 'filter', label: 'ãƒ•ã‚£ãƒ«ã‚¿', desc: 'æ°´æ¿¡ã‚Œã€ç›®è©°ã¾ã‚Šãªã—' },
                { id: 'heart', label: 'å‹•ä½œè¡¨ç¤º', desc: 'ãƒãƒ¼ãƒˆãƒãƒ¼ã‚¯ãŒç‚¹æ»…ä¸­' }
            ]
        };

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = window.__app_id || 'gx3r-log-system-v2';
        const apiKey = "";

        let currentUser = null;
        let todayData = {};
        let inspectionState = {};

        // --- 2. CORE UTILITIES ---
        const getLocalDateString = (date) => {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        };

        const getLocalMonthString = (date) => {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        };

        const showLoader = (show) => {
            const loader = document.getElementById('global-loader');
            if(loader) loader.classList.toggle('hidden', !show);
        };

        window.showMessage = (msg, icon = "â„¹ï¸") => {
            const box = document.getElementById('custom-alert');
            const txt = document.getElementById('alert-message');
            const icn = document.getElementById('alert-icon');
            if(!box || !txt) return;
            icn.innerText = icon;
            txt.innerText = msg;
            box.style.display = "flex";
            setTimeout(() => { box.style.display = "none"; }, 4000);
        };

        window.triggerPrint = () => {
            try {
                window.print();
                // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å†…ã§ã®åˆ¶é™ã«å¯¾ã™ã‚‹æ¡ˆå†…
                if (window.location.hostname.includes("usercontent.goog")) {
                    window.showMessage("ã“ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»é¢ã§ã¯å°åˆ·ãŒåˆ¶é™ã•ã‚Œã¦ã„ã¾ã™ã€‚GitHubã«å…¬é–‹ã—ãŸURLã‹ã‚‰å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚", "âš ï¸");
                }
            } catch (e) {
                window.showMessage("å°åˆ·ã‚’é–‹å§‹ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚", "âŒ");
            }
        };

        window.updateDashboardSummary = () => {
            const points = [...config.measurementPoints].reverse();
            let lastData = null;
            for (const p of points) {
                if (todayData && todayData[p.id]) {
                    lastData = todayData[p.id];
                    break;
                }
            }
            const dashO2 = document.getElementById('dash-o2');
            const dashLel = document.getElementById('dash-lel');
            if (lastData) {
                if (dashO2) dashO2.innerText = (lastData.o2 !== undefined) ? Number(lastData.o2).toFixed(1) : '--.-';
                if (dashLel) dashLel.innerText = (lastData.lel !== undefined) ? lastData.lel : '--';
            } else {
                if (dashO2) dashO2.innerText = '--.-';
                if (dashLel) dashLel.innerText = '--';
            }
        };

        const startAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else { await signInAnonymously(auth); }
        };

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) loadTodayData();
        });

        startAuth();

        const getRecordDoc = (dateStr) => {
            if (!dateStr || dateStr.trim() === "") return null;
            return doc(db, 'artifacts', appId, 'public', 'data', 'daily_records', dateStr);
        };

        window.loadTodayData = async () => {
            const dateInput = document.getElementById('input-date');
            if (!dateInput || !currentUser) return;
            const dateStr = dateInput.value;
            showLoader(true);
            try {
                const snap = await getDoc(getRecordDoc(dateStr));
                todayData = snap.exists() ? snap.data() : {};
                document.getElementById('work-content-area').value = todayData.work_content || '';
                const dateBadge = document.getElementById('current-date-badge');
                if (dateBadge) dateBadge.innerText = dateStr;
                inspectionState = todayData.inspection || {};
                renderInspectionUI();
                renderEntryForms();
                updateDashboardSummary();
            } catch (err) { console.error("Load error", err); }
            finally { showLoader(false); }
        };

        window.saveDailyRecord = async () => {
            const dateStr = document.getElementById('input-date').value;
            if (!currentUser || !dateStr) return;
            showLoader(true);
            const record = { inspection: inspectionState, work_content: document.getElementById('work-content-area').value, timestamp: Date.now() };
            config.measurementPoints.forEach(p => {
                const pData = {};
                let hasPointData = false;
                config.gases.forEach(g => {
                    const el = document.getElementById(`${p.id}-${g.id}`);
                    if (el && el.value !== '') {
                        const val = g.step === '1' ? parseInt(el.value) : parseFloat(el.value);
                        pData[g.id] = val;
                        hasPointData = true;
                    }
                });
                if (hasPointData) record[p.id] = pData;
            });
            await setDoc(getRecordDoc(dateStr), record, { merge: true });
            todayData = record;
            renderEntryForms();
            updateDashboardSummary();
            await loadMonthlyTable(); 
            showLoader(false);
            window.showMessage("ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜ã—ã¾ã—ãŸã€‚");
            switchTab('dashboard');
        };

        window.saveWorkContent = async () => {
            const dateStr = document.getElementById('input-date').value;
            const content = document.getElementById('work-content-area').value;
            if (!currentUser || !dateStr) return;
            await setDoc(getRecordDoc(dateStr), { work_content: content }, { merge: true });
            todayData.work_content = content;
            window.showMessage("ä½œæ¥­å†…å®¹ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚");
        };

        function renderInspectionUI() {
            const container = document.getElementById('inspection-items-container');
            if (!container) return;
            container.innerHTML = config.inspectionItems.map(item => `
                <div class="flex justify-between items-center bg-slate-50 p-4 rounded-2xl border border-slate-100">
                    <div class="flex-1"><p class="text-sm font-bold text-slate-700">${item.label}</p><p class="text-[10px] text-slate-400 font-medium">${item.desc}</p></div>
                    <div class="flex bg-white rounded-xl p-1 border shadow-sm">
                        <button onclick="setInspection('${item.id}', true)" class="px-5 py-2 rounded-lg text-xs font-bold transition-all ${inspectionState[item.id] === true ? 'bg-emerald-500 text-white shadow-md' : 'text-slate-400'}">è‰¯</button>
                        <button onclick="setInspection('${item.id}', false)" class="px-5 py-2 rounded-lg text-xs font-bold transition-all ${inspectionState[item.id] === false ? 'bg-rose-500 text-white shadow-md' : 'text-slate-400'}">å¦</button>
                    </div>
                </div>
            `).join('');
            const isAllOk = config.inspectionItems.every(i => inspectionState[i.id] === true);
            const badge = document.getElementById('badge-inspection');
            if (badge) {
                badge.innerText = isAllOk ? 'ç¢ºèªæ¸ˆ' : 'æœªç¢ºèª/ç•°å¸¸';
                badge.className = `text-[10px] px-3 py-1 ${isAllOk ? 'bg-emerald-500 text-white' : 'bg-slate-700 text-slate-300'} rounded-full font-bold`;
            }
        }

        window.setInspection = (id, val) => { inspectionState[id] = val; renderInspectionUI(); };

        window.handleManualInput = (pointId) => {
            const hasData = config.gases.some(g => {
                const el = document.getElementById(`${pointId}-${g.id}`);
                return el && el.value !== '';
            });
            const badge = document.getElementById(`badge-${pointId}`);
            if (badge) {
                badge.innerText = hasData ? 'è¨˜å…¥ä¸­/æ¸ˆ' : 'æœªè¨˜å…¥';
                badge.className = `text-[10px] px-3 py-1 ${hasData ? 'bg-emerald-100 text-emerald-600' : 'bg-slate-200 text-slate-500'} rounded-full font-bold`;
            }
        };

        function renderEntryForms() {
            const container = document.getElementById('measurement-points-container');
            if (!container) return;
            container.innerHTML = config.measurementPoints.map(p => `
                <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden shadow-sm">
                    <button onclick="toggleAccordion('${p.id}')" class="w-full p-5 flex justify-between items-center bg-slate-50 hover:bg-slate-100 transition-colors">
                        <div class="text-left"><span class="text-[10px] font-black text-sky-600 uppercase tracking-widest">Step ${p.id === 'p1' ? '2' : parseInt(p.id.slice(1)) + 1}</span><h3 class="font-bold text-slate-800 text-lg">${p.label} <span class="text-xs text-slate-400 font-normal">(${p.type})</span></h3></div>
                        <span id="badge-${p.id}" class="text-[10px] px-3 py-1 ${(todayData[p.id]) ? 'bg-emerald-100 text-emerald-600' : 'bg-slate-200 text-slate-500'} rounded-full font-bold">${(todayData[p.id]) ? 'è¨˜éŒ²æ¸ˆ' : 'æœªè¨˜å…¥'}</span>
                    </button>
                    <div id="content-${p.id}" class="p-6 grid grid-cols-2 gap-4 hidden border-t border-slate-100">
                        ${config.gases.map(g => `<div class="space-y-1.5"><label class="text-[11px] font-extrabold text-slate-400 uppercase tracking-tighter">${g.label} ${g.id.toUpperCase()} (${g.unit})</label><input type="number" step="${g.step}" inputmode="decimal" id="${p.id}-${g.id}" oninput="handleManualInput('${p.id}')" value="${todayData[p.id]?.[g.id] || ''}" placeholder="${g.default}" class="w-full bg-slate-50 p-4 rounded-2xl border border-slate-200 input-focus font-black text-lg text-slate-800 shadow-inner"></div>`).join('')}
                    </div>
                </div>
            `).join('');
            config.measurementPoints.forEach(p => handleManualInput(p.id));
        }

        window.loadMonthlyTable = async () => {
            const selectEl = document.getElementById('report-month');
            if (!selectEl) return;
            const monthVal = selectEl.value;
            const table = document.getElementById('monthly-table');
            const printTitle = document.getElementById('print-month-title');
            if (printTitle) printTitle.innerText = monthVal + " åˆ†";
            
            table.innerHTML = `<thead class="bg-slate-900 text-white"><tr><th class="border border-slate-700 p-2" rowspan="2" style="width: 40px;">æ—¥ä»˜</th><th class="border border-slate-700 p-2" rowspan="2" style="width: 100px;">ä½œæ¥­å†…å®¹</th><th class="border border-slate-700 p-2 text-center" rowspan="2" style="width: 30px;">ç‚¹æ¤œ</th>${config.measurementPoints.map(p => `<th class="border border-slate-700 p-2 text-center text-[8px]" colspan="${config.gases.length}">${p.label}</th>`).join('')}</tr><tr class="bg-slate-800 text-[6px]">${config.measurementPoints.map(p => config.gases.map(g => `<th class="border border-slate-700 p-1 text-center">${g.id.toUpperCase()}</th>`).join('')).join('')}</tr></thead><tbody id="monthly-table-body" class="bg-white"></tbody>`;
            const body = document.getElementById('monthly-table-body');
            body.innerHTML = '<tr><td colspan="30" class="text-center p-8"><div class="dot-flashing mx-auto"></div></td></tr>';
            try {
                const snap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'daily_records'));
                const monthData = snap.docs.filter(d => d.id.startsWith(monthVal)).sort((a, b) => a.id.localeCompare(b.id));
                if (monthData.length === 0) { body.innerHTML = `<tr><td colspan="30" class="text-center p-8 font-bold text-slate-400">ãƒ‡ãƒ¼ã‚¿ãªã— (${monthVal})</td></tr>`; return; }
                body.innerHTML = monthData.map(doc => {
                    const d = doc.data(); const day = doc.id.split('-')[2] + "æ—¥";
                    const isInspOk = d.inspection && config.inspectionItems.every(i => d.inspection[i.id] === true);
                    const inspText = isInspOk ? 'OK' : (d.inspection && Object.keys(d.inspection).length > 0 ? 'NG' : '-');
                    let row = `<tr class="hover:bg-slate-50"><td class="border p-1 font-black text-center text-[8px]">${day}</td><td class="border p-1 text-[7px] leading-tight">${d.work_content || '-'}</td><td class="border p-1 text-center text-[8px] font-bold ${isInspOk ? 'text-emerald-600' : 'text-rose-600'}">${inspText}</td>`;
                    config.measurementPoints.forEach(p => { const pD = d[p.id] || {}; config.gases.forEach(g => { const val = pD[g.id]; let isWarning = false; if (val !== undefined) { if (g.threshold.min && val < g.threshold.min) isWarning = true; if (g.threshold.max && val > g.threshold.max) isWarning = true; } row += `<td class="border p-1 text-center text-[7px] ${isWarning ? 'bg-rose-50 text-rose-600 font-bold' : ''}">${val ?? '-'}</td>`; }); });
                    return row + `</tr>`;
                }).join('');
            } catch (err) { body.innerHTML = '<tr><td colspan="30" class="p-8 text-center text-rose-500">ã‚¨ãƒ©ãƒ¼</td></tr>'; }
        };

        window.switchTab = (tabId) => {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden-section'));
            const target = document.getElementById(`view-${tabId}`);
            if (target) target.classList.remove('hidden-section');
            document.querySelectorAll('nav button').forEach(b => b.classList.replace('text-sky-600', 'text-slate-400'));
            const activeNav = document.getElementById(`nav-${tabId}`);
            if (activeNav) activeNav.classList.replace('text-slate-400', 'text-sky-600');
            if (tabId === 'monthly') loadMonthlyTable();
        };

        window.toggleAccordion = (id) => {
            const content = document.getElementById(`content-${id}`);
            if (content) content.classList.toggle('hidden');
        };

        window.analyzeSafety = async () => {
            const area = document.getElementById('ai-chat-area'); if (!area) return;
            area.innerHTML = '<div class="dot-flashing mx-auto mt-4"></div>';
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: `ãƒ‡ãƒ¼ã‚¿: ${JSON.stringify(todayData)}ã€‚åŠ©è¨€ã‚’æ—¥æœ¬èªã§ã€‚` }] }] }) });
                const result = await response.json(); area.innerHTML = result.candidates[0].content.parts[0].text.replace(/\n/g, '<br>');
                document.getElementById('btn-ai-speak').disabled = false;
            } catch (e) { area.innerText = "ã‚¨ãƒ©ãƒ¼"; }
        };

        window.generateRiskAssessment = async () => {
            const content = document.getElementById('work-content-area').value;
            const dashAi = document.getElementById('dash-ai-text');
            if (!content) return;
            dashAi.innerHTML = '<div class="dot-flashing mt-2"></div>';
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: `ä½œæ¥­: "${content}"ã®ãƒªã‚¹ã‚¯åˆ†æã€‚` }] }] }) });
                const result = await response.json(); dashAi.innerHTML = result.candidates[0].content.parts[0].text.replace(/\n/g, '<br>');
                document.getElementById('ai-action-buttons').classList.remove('hidden');
            } catch (e) { dashAi.innerText = "å¤±æ•—"; }
        };

        window.onload = () => {
            const select = document.getElementById('report-month');
            const now = new Date();
            for (let m = 1; m <= 7; m++) {
                const opt = document.createElement('option');
                opt.value = `2026-${String(m).padStart(2, '0')}`;
                opt.text = `2026å¹´${m}æœˆ`;
                select.appendChild(opt);
            }
            select.value = "2026-01";
            document.getElementById('input-date').value = getLocalDateString(now);
            renderInspectionUI();
            renderEntryForms();
        };
    </script>
</body>
</html>
